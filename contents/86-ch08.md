---

## Section 6: Aggregate Functions with GROUP BY in Multi-Table Queries

When data is spread across multiple tables, sometimes you want **summaries**
instead of individual rows. That’s where SQL’s **aggregate functions** come in.

You’ve already seen functions like `COUNT()`, `SUM()`, and `AVG()` in earlier
chapters. In this section, we’ll use those tools together with **joins** to
answer questions like:

* How many students are enrolled in each course?
* What’s the average number of enrollments per student?
* Which course has the most students?

### 1. Aggregates Review

These are the main aggregate functions you’ll use:

* `COUNT()` – counts the number of rows
* `SUM()` – adds up numeric values
* `AVG()` – calculates an average
* `MAX()` / `MIN()` – find the largest or smallest values

Aggregates **collapse multiple rows into a single result**, based on a grouping.

### 2. GROUP BY With Joins

Let’s start with a simple query: count the number of students per course.

```sql
SELECT courses.title, COUNT(enrollments.student_id) AS num_students
FROM courses
JOIN enrollments ON courses.id = enrollments.course_id
GROUP BY courses.title;
```

* The join lets us access both course titles and student enrollments
* `GROUP BY` groups rows based on course title
* `COUNT()` tallies the number of students in each group

**Example Result:**

| title       | num_students |
| ----------- | ------------ |
| Biology 101 | 2            |
| Chemistry 1 | 1            |

### 3. Including Courses with No Enrollments

If you want to include *all* courses, even ones with zero enrollments, use a
`LEFT JOIN`:

```sql
SELECT courses.title, COUNT(enrollments.student_id) AS num_students
FROM courses
LEFT JOIN enrollments ON courses.id = enrollments.course_id
GROUP BY courses.title;
```

Without the `LEFT JOIN`, courses with no enrollments would be missing from the
result entirely.

### 4. Using HAVING to Filter Groups

`HAVING` filters *after aggregation* — unlike `WHERE`, which filters *before*.

**Example:** Only show courses with more than 1 student:

```sql
SELECT courses.title, COUNT(enrollments.student_id) AS num_students
FROM courses
JOIN enrollments ON courses.id = enrollments.course_id
GROUP BY courses.title
HAVING num_students > 1;
```

If you used `WHERE` here, it wouldn’t work — the `num_students` column doesn’t
exist until after `GROUP BY` runs.

### 5. Common Mistakes

| Mistake                                         | Correction                                        |
| ----------------------------------------------- | ------------------------------------------------- |
| Using `WHERE` on aggregate functions            | Use `HAVING` instead                              |
| Forgetting to `GROUP BY` non-aggregated columns | Always group by the column you’re not aggregating |
| Joining too early or too late                   | Make sure the join is needed before grouping      |

> **Helpful Hint:**
> Think of `GROUP BY` as “collapsing” rows into categories — and aggregates as
> the tools you use to summarize each group.

