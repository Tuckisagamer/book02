---

## Section 9: Using Peewee with Bottle.py

Now that you're familiar with how Peewee models interact with data, it's time
to see how they can be integrated into a web application using Bottle.py. This
lightweight web framework allows you to build simple, elegant Python web
servers — and with Peewee, you can serve data from your database dynamically.

### Setting Up Bottle with Peewee

First, install Bottle (if not already installed):

```bash
pip install bottle
```

A minimal Bottle app that connects to your Peewee database might look like this:

```python
from bottle import Bottle, run, template
from models import db, Airplane

app = Bottle()

@app.route('/')
def index():
    planes = Airplane.select()
    return template('airplanes', airplanes=planes)

if __name__ == "__main__":
    db.connect()
    run(app, host='localhost', port=8080, debug=True)
```

In this example:

* The `/` route fetches all airplanes from the database.
* A template called `airplanes.tpl` will be used to render the page.

### Creating a Template for Output

In a `views/` folder, create the `airplanes.tpl` file:

```html
<!DOCTYPE html>
<html>
<head><title>Airplanes</title></head>
<body>
  <h1>List of Airplanes</h1>
  <ul>
  % for plane in airplanes:
    <li>{{plane.name}} - {{plane.range_km}} km</li>
  % end
  </ul>
</body>
</html>
```

Bottle uses a simple templating syntax that lets you embed Python expressions
directly in HTML.

### Creating a Form to Insert Data

You can add a form to allow users to insert new airplanes:

```html
<form action="/add" method="post">
  Name: <input name="name" /><br />
  Range: <input name="range_km" /><br />
  <input type="submit" />
</form>
```

And the route in your app:

```python
from bottle import request, redirect

@app.post('/add')
def add_airplane():
    name = request.forms.get('name')
    range_km = int(request.forms.get('range_km'))
    Airplane.create(name=name, range_km=range_km)
    redirect('/')
```

Now your app can display data *and* allow users to modify it through the
browser.

### Keeping the Database Connection Clean

Bottle doesn't manage database connections automatically. To keep things tidy,
use hooks to open and close the database connection on each request:

```python
@app.hook('before_request')
def _connect():
    db.connect()

@app.hook('after_request')
def _close():
    if not db.is_closed():
        db.close()
```

> **Helpful Hint:**
> Always close your database connection to avoid connection limits or locked
> files (especially when using SQLite). There are other options to handle this
> that can be more performant but at a cost of the risk of certain issues.

This section completes your first fully functional database-powered web app
with Peewee and Bottle. In the next chapter, you’ll build on this by learning
how to structure **APIs using Bottle.py** and return data in JSON format for
modern web apps or third-party clients.

